name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libsecret-1-0 libsecret-1-dev gnome-keyring dbus-x11

      - name: Install dependencies
        run: bun install

      - name: Build all packages
        run: bun run build

      - name: Reinstall to update workspace copies
        run: bun install

      - name: Verify build artifacts
        run: |
          echo "=== Verifying all package builds ==="
          # Note: server uses Supabase Edge Functions (Deno), web uses Vite - neither produce dist/index.js
          for pkg in trust secrets shared execution api mcp-server cli; do
            echo "Checking packages/$pkg/dist..."
            if [ ! -f "packages/$pkg/dist/index.js" ]; then
              echo "ERROR: packages/$pkg/dist/index.js not found!"
              exit 1
            fi
            echo "âœ“ packages/$pkg/dist/index.js exists"
          done
          echo "=== Verifying workspace symlinks ==="
          ls -la node_modules/@enactprotocol/ || echo "No @enactprotocol symlinks!"
          echo "=== All build artifacts verified ==="

      - name: Lint
        run: bun run lint

      - name: Type check
        run: bun run typecheck

      - name: Test
        run: bun run test

      - name: Verify CLI runs
        run: bun packages/cli/dist/index.js --version
